@{
    ViewData["Title"] = "Trading Targets";
}

<h2 class="mb-4">My Trading Targets</h2>

<!-- IBEX Price Chart -->
<h4 class="mb-3">ðŸ“ˆ IBEX Spot Market Prices (BGN/MWh)</h4>
<div class="card mb-4">
    <div class="card-body">
        <canvas id="ibexPriceChart" height="120"></canvas>
        <small class="text-muted">ðŸ’¡ Click a point to assign the price.</small>
    </div>
</div>

<!-- Target Settings Table -->
<form method="post">
    <table class="table table-bordered align-middle">
        <thead class="table-light">
        <tr>
            <th>Asset</th>
            <th>Suggested Sell</th>
            <th>Your Sell</th>
            <th>Suggested Stop</th>
            <th>Your Stop</th>
            <th>Status</th>
            <th>Save</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>South PV Field</td>
            <td>210.00 BGN</td>
            <td>
                <input type="number" step="0.01" id="targetPriceInput" name="UserSellTargets[0]" class="form-control" value="210.00" />
            </td>
            <td>190.00 BGN</td>
            <td>
                <input type="number" step="0.01" id="stopPriceInput" name="UserStopTargets[0]" class="form-control" value="190.00" />
            </td>
            <td><span class="badge bg-primary">Using AI</span></td>
            <td>
                <button type="submit" class="btn btn-sm btn-outline-success">ðŸ’¾</button>
            </td>
        </tr>
        </tbody>
    </table>
</form>

<!-- Bootstrap Modal for Selecting Target or Stop -->
<div class="modal fade" id="priceModal" tabindex="-1" aria-labelledby="priceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="priceModalLabel">Assign Price</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-4">You clicked on price: <strong id="clickedPriceText">---</strong> BGN</p>
                <button id="setTargetBtn" type="button" class="btn btn-success me-2">ðŸŽ¯ Set as Target Sell Price</button>
                <button id="setStopBtn" type="button" class="btn btn-danger">ðŸ›‘ Set as Stop Price</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let clickedPrice = null;

        const ibexCtx = document.getElementById('ibexPriceChart');
        const targetInput = document.getElementById("targetPriceInput");
        const stopInput = document.getElementById("stopPriceInput");

        const priceModal = new bootstrap.Modal(document.getElementById('priceModal'));
        const clickedPriceText = document.getElementById("clickedPriceText");

        document.getElementById("setTargetBtn").addEventListener("click", () => {
            if (clickedPrice && targetInput) {
                targetInput.value = clickedPrice.toFixed(2);
                targetInput.classList.add("border-success", "fw-bold");
                priceModal.hide();
            }
        });

        document.getElementById("setStopBtn").addEventListener("click", () => {
            if (clickedPrice && stopInput) {
                stopInput.value = clickedPrice.toFixed(2);
                stopInput.classList.add("border-danger", "fw-bold");
                priceModal.hide();
            }
        });

        const ibexChart = new Chart(ibexCtx, {
            type: 'line',
            data: {
                labels: [
                    '00:00', '01:00', '02:00', '03:00', '04:00', '05:00',
                    '06:00', '07:00', '08:00', '09:00', '10:00', '11:00',
                    '12:00', '13:00', '14:00', '15:00', '16:00', '17:00',
                    '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'
                ],
                datasets: [{
                    label: 'IBEX Spot Price (BGN/MWh)',
                    data: [
                        194.2, 191.1, 187.3, 185.8, 188.0, 193.2,
                        206.5, 218.3, 225.7, 229.1, 222.8, 215.0,
                        210.4, 208.6, 206.3, 203.9, 198.5, 193.7,
                        189.2, 185.4, 183.6, 182.1, 180.9, 179.5
                    ],
                    fill: true,
                    tension: 0.3,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    pointRadius: 4
                }]
            },
            options: {
                onClick: (evt, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        clickedPrice = ibexChart.data.datasets[0].data[index];
                        clickedPriceText.innerText = clickedPrice.toFixed(2);
                        priceModal.show();
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Price (BGN/MWh)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Hour'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.parsed.y} BGN/MWh`;
                            }
                        }
                    }
                }
            }
        });
    </script>
}
