@using Microsoft.AspNetCore.Mvc.TagHelpers
@model SunNext.Web.ViewModels.SolarSystem.SolarSystemViewModel

@{
    ViewData["Title"] = "System Details";
}



<div class="container py-4">
    <!-- Header Section -->
    <div class="asset-header fade-in">
        <h1 class="asset-title">
            <i class="bi bi-sun"></i>
            @Model.Name
        </h1>
        <div class="status-indicator">
            <div class="status-dot @(Model.IsOnline ? "bg-success" : "bg-secondary")"></div>
            <span class="@(Model.IsOnline ? "text-success" : "text-secondary")">
                @(Model.IsOnline ? "Active & Generating" : "Offline")
            </span>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons fade-in">
        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-warning">
            <i class="bi bi-pencil-square"></i> Edit System
        </a>
        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
            <i class="bi bi-trash"></i> Delete System
        </button>
    </div>
    
    <!-- Metrics Grid -->
    <div class="metric-grid fade-in">
        <div class="metric-card">
            <div class="metric-value">@Model.PowerKw</div>
            <div class="metric-label">
                <i class="bi bi-lightning-charge"></i>
                kW Power
                <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                   title="Maximum instantaneous output of the solar system in kilowatts (kW)."></i>
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-value">@Model.EfficiencyPercent%</div>
            <div class="metric-label">
                <i class="bi bi-speedometer2"></i>
                Efficiency
                <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                   title="Efficiency represents how much of the sunlight is converted into usable energy."></i>
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-value">@Model.CapacityKw</div>
            <div class="metric-label">
                <i class="bi bi-battery-full"></i>
                kWp Capacity
                <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                   title="Total installed peak capacity measured under standard conditions."></i>
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-value">@Model.EnergyTodayKWh</div>
            <div class="metric-label">
                <i class="bi bi-calendar-day"></i>
                kWh Today
                <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                   title="Total energy produced by the system today in kilowatt-hours."></i>
            </div>
        </div>
    </div>

    <!-- Main Content Layout -->
    <div class="content-layout">
        <!-- Left Column - Details -->
        <div class="details-column">
            <!-- Energy Production Section -->
            <div class="info-section fade-in">
                <h5 class="section-title">Energy Production</h5>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Today's Generation</span>
                        <span class="info-value">
                            @Model.EnergyTodayKWh kWh
                            <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                               title="Energy generated today"></i>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">This Month</span>
                        <span class="info-value">
                            @Model.EnergyMonthKWh kWh
                            <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                               title="Energy generated this month"></i>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">This Year</span>
                        <span class="info-value">
                            @Model.EnergyYearKWh kWh
                            <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                               title="Energy generated this year"></i>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Total Lifetime</span>
                        <span class="info-value">
                            @Model.EnergyTotalKWh kWh
                            <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                               title="Total energy produced since commissioning"></i>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Technical Specifications -->
            <div class="info-section fade-in">
                <h5 class="section-title">Technical Specifications</h5>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Maximum Power Output</span>
                        <span class="info-value">
                            @Model.PowerKw kW
                            <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                               title="Maximum power output under optimal conditions"></i>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">System Efficiency</span>
                        <span class="info-value">
                            @Model.EfficiencyPercent%
                            <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                               title="Overall system efficiency rating"></i>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Installed Capacity</span>
                        <span class="info-value">
                            @Model.CapacityKw kWp
                            <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                               title="Total installed peak capacity"></i>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Panel Technology</span>
                        <span class="info-value">
                            @Model.Type
                            <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                               title="Type of solar panel technology used"></i>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Installation Details -->
            <div class="info-section fade-in">
                <h5 class="section-title">Installation Details</h5>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Installation Company</span>
                        <span class="info-value">
                            @Model.InstallerName
                            <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                               title="Company that installed the system"></i>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Contact Email</span>
                        <span class="info-value">
                            @Model.InstallerEmail
                            <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                               title="Installer contact email"></i>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Contact Phone</span>
                        <span class="info-value">
                            @Model.InstallerPhone
                            <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                               title="Installer contact phone number"></i>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Commissioning Date</span>
                        <span class="info-value">
                            @Model.CommissioningDate.ToString("dd MMM yyyy", new System.Globalization.CultureInfo("en-US"))
                            <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                               title="Date when the system was commissioned and activated"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Sidebar -->
        <div class="sidebar-column">
            <!-- Asset Image -->
            <div class="sidebar-section fade-in">
                <div class="asset-image">
                    <img src="@Model.ImageUrl" class="img-fluid" alt="@Model.Name"/>
                </div>
                <p class="text-center" style="color: #888; margin: 0;">Virtual Power Station</p>
            </div>

            <!-- Location & Map -->
            <div class="sidebar-section fade-in">
                <h5 class="section-title">Installation Location</h5>
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-overlay"></div>
                </div>
                <div class="location-info">
                    <div class="location-item">
                        <i class="bi bi-geo-alt-fill location-icon"></i>
                        <div>
                            <span class="location-label">Address</span>
                            <div class="location-text">@Model.Address</div>
                        </div>
                        <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                           title="Installation address"></i>
                    </div>
                    <div class="location-item">
                        <i class="bi bi-clock location-icon"></i>
                        <div>
                            <span class="location-label">Time Zone</span>
                            <div class="location-text">@Model.TimeZone</div>
                        </div>
                        <i class="bi bi-info-circle tooltip-icon" data-bs-toggle="tooltip"
                           title="Local time zone for this installation"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-0">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete asset <strong>@Model.Name</strong>?
                </div>
                <div class="modal-footer border-0">
                    <form asp-action="Delete" asp-route-id="@Model.Id" method="post">
                        <button type="submit" class="btn btn-danger">Yes, Delete</button>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Initialize tooltips
        initTooltips();

        // Initialize map
        mapboxgl.accessToken = 'pk.eyJ1IjoiamFja3NvbmpzMTIiLCJhIjoiY21keHR0bDNrMDFzbzJrcDhubWc3Z3U1OSJ9.yKm2mo_L6o8uAteyHxVt3A';
        initializeMap();

        // Intersection Observer for fade-in animations
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, {threshold: 0.1});

        // Observe fade-in elements
        document.querySelectorAll('.fade-in').forEach(el => observer.observe(el));
    });

    function initializeMap() {
        const address = "@Model.Address";
        const encoded = encodeURIComponent(address);

        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encoded}.json?access_token=${mapboxgl.accessToken}&limit=1`)
            .then(response => response.json())
            .then(data => {
                if (!data.features || data.features.length === 0) {
                    showMapFallback("Location not found on map");
                    return;
                }

                const [lon, lat] = data.features[0].center;

                const map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/dark-v11',
                    center: [lon, lat],
                    zoom: 15
                });

                map.addControl(new mapboxgl.NavigationControl(), 'top-right');

                new mapboxgl.Marker({color: '#0dcaf0'})
                    .setLngLat([lon, lat])
                    .setPopup(new mapboxgl.Popup({offset: 12}).setHTML(
                        `<strong style="color:#0dcaf0;">@Model.Name</strong><br><small>${address}</small>`
                    ))
                    .addTo(map)
                    .togglePopup();

                // Re-initialize tooltips after map renders
                map.once('load', () => setTimeout(initTooltips, 300));
            })
            .catch(error => {
                console.error(error);
                showMapFallback("Failed to load map");
            });
    }

    function showMapFallback(msg) {
        document.getElementById('map').innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;height:100%;background:rgba(0,0,0,.3);color:#888;font-size:.9rem;">
            <div style="text-align:center;">
                <i class="bi bi-geo-alt" style="font-size:2rem;color:#666;margin-bottom:.5rem;"></i><br>${msg}
            </div>
        </div>`;
    }


    function initTooltips() {
        // Dispose existing tooltips
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
            const existingTooltip = bootstrap.Tooltip.getInstance(el);
            if (existingTooltip) {
                existingTooltip.dispose();
            }
        });

        // Initialize new tooltips
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
            new bootstrap.Tooltip(el, {
                container: 'body',
                placement: 'top',
                boundary: 'viewport'
            });
        });
    }
</script>